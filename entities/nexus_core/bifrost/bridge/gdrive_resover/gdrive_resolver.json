{
  "gdrive_resolver": {
    "schema_version": "1.0",
    "version": "1.0",
    "entity": "GDrive Resolver",
    "role": "plugin resolver for Google Drive file IDs",
    "abstract": "Resolves Google Drive resources strictly by File ID or file-URL-with-ID. No virtual paths. Optional lookup via local ID index (JSON/TXT).",

    "policy": {
      "accept_id_or_file_url_only": true,
      "reject_folders": true,
      "no_virtual_paths": true,
      "local_first": true,
      "use_index_when_ref_is_key": true,
      "explain_on_error": true
    },

    "index_files": {
      "json": "entities/nexus_core/gdrive_index.json",
      "txt":  "entities/nexus_core/gdrive_index.txt"
    },

    "interface": {
      "resolve": {
        "input": {
          "type": "object",
          "required": ["ref"],
          "properties": {
            "ref": {
              "type": "string",
              "description": "Either a Google Drive File ID, a file URL containing the ID, or a logical key like oracle.predictive_engine"
            }
          }
        },
        "output": {
          "type": "object",
          "required": ["status"],
          "properties": {
            "status": { "enum": ["ok", "error"] },
            "resolved_via": { "enum": ["id", "url", "key"] },
            "file": {
              "type": "object",
              "properties": {
                "id": { "type": "string" },
                "title": { "type": "string" },
                "mimeType": { "type": "string" },
                "lastModifiedTime": { "type": "string" },
                "size": { "type": "integer" },
                "webViewLink": { "type": "string" }
              }
            },
            "error": {
              "type": "object",
              "properties": {
                "code": { "type": "string" },
                "message": { "type": "string" },
                "hint": { "type": "string" }
              }
            }
          }
        }
      }
    },

    "patterns": {
      "id_regex": "^[A-Za-z0-9_-]{20,}$",
      "file_url_regexes": [
        "^https:\\/\\/drive\\.google\\.com\\/file\\/d\\/([A-Za-z0-9_-]{20,})(?:\\/|\\?|$)",
        "^https:\\/\\/drive\\.google\\.com\\/open\\?id=([A-Za-z0-9_-]{20,})",
        "^https:\\/\\/drive\\.google\\.com\\/uc\\?id=([A-Za-z0-9_-]{20,})"
      ],
      "blocked_regexes": [
        "^https:\\/\\/drive\\.google\\.com\\/drive\\/folders\\/.*$"
      ],
      "key_regex": "^[A-Za-z][A-Za-z0-9_.-]{1,127}$"
    },

    "normalize": {
      "steps": [
        { "rule": "trim_whitespace" },
        { "rule": "collapse_multiple_slashes" },
        {
          "rule": "extract_id_from_url_if_match",
          "sources": "patterns.file_url_regexes"
        },
        {
          "rule": "classify_ref",
          "logic": [
            { "if": "matches(patterns.id_regex)", "as": "id" },
            { "if": "matches(patterns.file_url_regexes[0..2])", "as": "url" },
            { "if": "matches(patterns.blocked_regexes[0])", "as": "blocked_folder" },
            { "if": "matches(patterns.key_regex)", "as": "key" },
            { "else": "unknown" }
          ]
        }
      ]
    },

    "strategy": {
      "resolution_order": ["id", "url", "key"],
      "on_blocked_folder": "error:E_FOLDER_REF_UNSUPPORTED",
      "on_unknown": "error:E_NOT_GDRIVE_REFERENCE",
      "on_key": {
        "lookup": ["index.json", "index.txt"],
        "missing_key_behavior": "error:E_KEY_NOT_FOUND"
      }
    },

    "errors": {
      "E_FOLDER_REF_UNSUPPORTED": "Folder references are not supported; provide a file URL/ID.",
      "E_NOT_GDRIVE_REFERENCE": "Not a recognizable Google Drive file reference.",
      "E_KEY_NOT_FOUND": "Key not found in local GDrive index.",
      "E_NOT_FOUND": "Google Drive object not found or not accessible."
    },

    "cli": {
      "commands": {
        "update": {
          "name": "gdrive update",
          "usage": "gdrive update <key> [<key> ...]",
          "description": "Add or update one or more keyâ†’ID mappings in the local index. After each key, you will be prompted for a Drive file URL or ID.",
          "batch": true,
          "prompts": [
            "Enter Google Drive file LINK or ID for {key}: "
          ],
          "writes": [
            "entities/nexus_core/gdrive_index.json",
            "entities/nexus_core/gdrive_index.txt"
          ],
          "validation": {
            "accept_id_or_file_url_only": true,
            "reject_folders": true
          }
        },
        "show": {
          "name": "gdrive show",
          "usage": "gdrive show [<key-prefix>]",
          "description": "List keys (optionally filter by prefix) with their IDs from the local index.",
          "reads": [
            "entities/nexus_core/gdrive_index.json",
            "entities/nexus_core/gdrive_index.txt"
          ]
        },
        "remove": {
          "name": "gdrive remove",
          "usage": "gdrive remove <key> [<key> ...]",
          "description": "Remove one or more keys from the local index.",
          "writes": [
            "entities/nexus_core/gdrive_index.json",
            "entities/nexus_core/gdrive_index.txt"
          ]
        },
        "validate": {
          "name": "gdrive validate",
          "usage": "gdrive validate",
          "description": "Validate JSON/TXT index consistency and key/ID format.",
          "reads": [
            "entities/nexus_core/gdrive_index.json",
            "entities/nexus_core/gdrive_index.txt"
          ]
        }
      }
    },

    "healthcheck": {
      "on_boot": true,
      "checks": [
        { "path": "index_files.json", "must_exist": true },
        { "path": "index_files.txt",  "must_exist": true }
      ],
      "policy": {
        "allow_empty_index": true
      }
    },

    "audit": {
      "record_normalized_ref": true,
      "record_resolution_path": true,
      "log_level": "minimal"
    }
  }
}